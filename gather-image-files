
# TODO: Include version number in upgrade bundle
# TODO: Make upgrade script untar upgrade bundle contents to replace /serval contents


rm -fr staging
mkdir -p staging
cd staging
for p in minicom_ libpcap libncurses_ terminfo_ mkdosfs_ dosfsck_ dosfslabel_ python coreutils bash procps curl_ sed_ gawk_ grep_ netcat_ chilli zlib tcpdump_
do
  for f in `ls -1 ../Open*/packages/${p}*`
  do
     echo $f
     # some versions of tar don't realise the ./ can be ignored, so we ask for both
     tar zxvf ${f} ./data.tar.gz data.tar.gz
     tar zxvf data.tar.gz
  done
done

rm data.tar.gz

mv usr/lib lib
mv lib/lib/* lib
mv usr/sbin sbin
mv usr/bin/* bin
mv usr/share share
mv usr/include include
mv usr/libexec libexec
rmdir usr/bin
rmdir usr

# Now add python packages for serial and expect for talking to the radio.
mkdir -p lib/python2.7/site-packages
cd lib/python2.7/site-packages
pwd
tar zxvf ../../../../pypackages.tgz
cd ../../..

# Put servald binary into staging directory
cp ../servald/servald servald

# Make tgz of staged /serval partition
mkdir -p ../upgrade
tar zcvf ../upgrade/serval.tgz .

# Leave staging directory
cd ..

# Build upgrade file
cd upgrade
cp ../servald/servald servald
cp ../servald/serval.conf serval.conf
mkdir -p platform
touch platform/tl-mr3020
cp ../openwrt-ar71xx-generic-tl-mr3020-v1-squashfs-factory.bin
tar zcvf ../serval.up *
cd ..
